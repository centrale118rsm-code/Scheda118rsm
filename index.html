<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>118 Mobile Terminal - Email System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-app: #eef1f5;
            --bg-card: #ffffff;
            --primary: #0056b3;
            --text-main: #2c3e50;
            --border: #dde1e7;
            --status-standby: #7f8c8d;
            --status-active: #27ae60;
            --tr-green: #2ecc71;
            --tr-yellow: #f1c40f;
            --tr-red: #e74c3c;
            --tr-blue: #3498db;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- UI COMPONENTS --- */
        .top-bar {
            background: #1a252f; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem;
        }
        .mission-header {
            background: white; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .mission-id { font-weight: 800; font-size: 1.2rem; color: var(--primary); }
        .mission-status-badge {
            padding: 5px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.8rem; background-color: var(--status-standby);
        }

        .main-content {
            flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } }

        .card {
            background: var(--bg-card); border-radius: 6px; border: 1px solid var(--border); padding: 12px; margin-bottom: 5px;
        }
        .card.full-width { grid-column: span 2; }
        @media (max-width: 900px) { .card.full-width { grid-column: span 1; } }

        .card-title { font-size: 0.75rem; font-weight: 700; color: #7f8c8d; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }

        .data-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .data-field { flex: 1; }
        .data-field label { display: block; font-size: 0.7rem; color: #666; }
        .data-field input { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; }
        .locked-input { background-color: #e9ecef; pointer-events: none; }

        .vitals-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .vital-box { text-align: center; }
        .vital-box input { text-align: center; font-family: 'Roboto Mono', monospace; font-size: 1.1rem; color: var(--primary); width: 100%; }

        /* GCS Buttons */
        .gcs-selector { display: flex; justify-content: space-between; margin-bottom: 5px; background: #f9f9f9; padding: 5px; }
        .gcs-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; cursor: pointer; }
        .gcs-btn.active { background: #34495e; color: white; }

        /* Triage Buttons */
        .triage-row { display: flex; gap: 5px; }
        .triage-btn { flex: 1; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; opacity: 0.6; }
        .triage-btn.active { opacity: 1; transform: scale(1.05); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* Bottom Bar */
        .bottom-bar { background: white; padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
        .btn-test { background: #e67e22; }
        .btn-send { background: var(--primary); }

        /* Overlay Alert */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(192, 57, 43, 0.95); z-index: 999; display: none;
            flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white;
        }
        .call-card { background: white; color: #333; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; }
        
    </style>
</head>
<body>

    <div class="overlay" id="incomingOverlay">
        <div class="call-card">
            <h2 style="margin:0; color:#c0392b;">‚ö†Ô∏è MISSIONE 118</h2>
            <div style="margin: 20px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; padding:15px 0;">
                <div><strong>CODICE:</strong> <span id="alert_code" style="font-size:1.5rem; font-weight:900; color:red;">ROSSO</span></div>
                <div><strong>MOTIVO:</strong> <span id="alert_motivo">--</span></div>
                <div><strong>LUOGO:</strong> <span id="alert_indirizzo">--</span></div>
            </div>
            <button onclick="acceptMission()" style="width:100%; padding:15px; background:#27ae60; color:white; border:none; font-size:1.2rem; font-weight:bold; border-radius:6px;">‚úÖ ACCETTA</button>
        </div>
    </div>

    <div class="top-bar">
        <span>CENTRALE 118: <strong>CONNESSA</strong></span>
        <span id="clock">00:00:00</span>
    </div>

    <div class="mission-header">
        <div>
            <div style="font-size:0.7rem;">ID MISSIONE</div>
            <div class="mission-id" id="mission_id">--</div>
        </div>
        <div class="mission-status-badge" id="status_badge">STANDBY</div>
    </div>

    <div class="main-content" id="schedaContainer">
        
        <div class="card full-width" style="background:#f8f9fa; border-left:4px solid var(--primary);">
            <div class="card-title">üì° DATI DA CENTRALE</div>
            <div class="data-row">
                <div class="data-field"><label>INDIRIZZO</label><input type="text" id="in_indirizzo" class="locked-input" readonly></div>
            </div>
            <div class="data-row">
                <div class="data-field"><label>PAZIENTE</label><input type="text" id="in_nome" class="locked-input" readonly></div>
                <div class="data-field"><label>ET√Ä</label><input type="text" id="in_eta" class="locked-input" readonly></div>
                <div class="data-field"><label>CODICE</label><input type="text" id="in_codice" class="locked-input" readonly style="font-weight:bold;"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ü©∫ PARAMETRI</div>
            <div class="vitals-grid">
                <div class="vital-box"><label>FC</label><input type="number"></div>
                <div class="vital-box"><label>SpO2</label><input type="number"></div>
                <div class="vital-box"><label>PA</label><input type="number"></div>
                <div class="vital-box"><label>FR</label><input type="number"></div>
                <div class="vital-box"><label>GCS</label><input type="number" id="gcs_manual_val"></div>
                <div class="vital-box"><label>NRS</label><input type="number"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìù NOTE / ANAMNESI</div>
            <textarea style="width:100%; height:80px; padding:5px; border:1px solid #ccc;" placeholder="Scrivi qui..."></textarea>
        </div>

        <div class="card full-width">
            <div class="card-title">üöë ESITO</div>
            <div class="triage-row">
                <button class="triage-btn" style="background:var(--tr-green);" onclick="selTriage(this)">V</button>
                <button class="triage-btn" style="background:var(--tr-yellow);" onclick="selTriage(this)">G</button>
                <button class="triage-btn" style="background:var(--tr-red);" onclick="selTriage(this)">R</button>
                <button class="triage-btn" style="background:black; color:white;" onclick="selTriage(this)">X</button>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="action-btn btn-test" onclick="triggerSim()">üîî SIMULA</button>
        <button class="action-btn btn-send" onclick="sendEmailWithPDF()">üì§ INVIA PDF VIA EMAIL</button>
    </div>

    <script>
        // Orologio
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);

        // Simulazione
        const missioni = [
            {code:"ROSSO", mot:"Dolore Toracico", addr:"Via del Poggio 22", nome:"Mario Rossi", eta:"64"},
            {code:"GIALLO", mot:"Trauma Arto Inf", addr:"Campo Sportivo", nome:"Luca Bianchi", eta:"24"}
        ];

        function triggerSim() {
            const m = missioni[Math.floor(Math.random()*missioni.length)];
            document.getElementById('alert_code').innerText = m.code;
            document.getElementById('alert_motivo').innerText = m.mot;
            document.getElementById('alert_indirizzo').innerText = m.addr;
            
            // Dati nascosti per popolamento
            window.tempMission = m;
            document.getElementById('incomingOverlay').style.display = 'flex';
        }

        function acceptMission() {
            const m = window.tempMission;
            document.getElementById('incomingOverlay').style.display = 'none';
            document.getElementById('status_badge').innerText = "IN MISSIONE";
            document.getElementById('status_badge').style.backgroundColor = "#27ae60";
            document.getElementById('mission_id').innerText = "2024-" + Math.floor(Math.random()*9000);

            // Popola campi
            document.getElementById('in_indirizzo').value = m.addr;
            document.getElementById('in_nome').value = m.nome;
            document.getElementById('in_eta').value = m.eta;
            document.getElementById('in_codice').value = m.code;
        }

        function selTriage(btn) {
            document.querySelectorAll('.triage-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- FUNZIONE CORRETTA PER INVIO EMAIL + PDF ---
        function sendEmailWithPDF() {
            const idMissione = document.getElementById('mission_id').innerText;
            
            if(idMissione === "--") {
                alert("Nessuna missione attiva da inviare!");
                return;
            }

            if(!confirm("Confermi chiusura intervento e invio email?")) return;

            // 1. Nascondiamo le barre per avere un PDF pulito della sola scheda
            const topBar = document.querySelector('.top-bar');
            const bottomBar = document.querySelector('.bottom-bar');
            topBar.style.display = 'none';
            bottomBar.style.display = 'none';

            // 2. Opzioni PDF
            const element = document.body;
            const opt = {
                margin: 0,
                filename: 'Scheda_118_' + idMissione + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // 3. Genera e Salva
            html2pdf().set(opt).from(element).save().then(() => {
                // 4. Ripristina interfaccia
                topBar.style.display = 'flex';
                bottomBar.style.display = 'flex';

                // 5. Prepara link Email
                const email = "centrale118@iss.sm";
                const subject = "Invio Scheda Intervento: " + idMissione;
                const body = "Si invia in allegato la scheda relativa all'intervento n. " + idMissione + ".";
                
                // 6. Apre il client di posta
                setTimeout(() => {
                    window.location.href = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    
                    // 7. Avviso fondamentale per l'utente
                    alert("‚úÖ PDF SCARICATO CORRETTAMENTE!\n\nAttenzione: Il tuo programma di posta si sta aprendo.\nRicordati di ALLEGARE MANUALMENTE il file PDF che √® appena stato scaricato nel tuo dispositivo.");
                }, 1000);
            });
        }
    </script>
</body>
</html>